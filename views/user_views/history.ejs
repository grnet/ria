<%- include('../partials/head.ejs') %>
<script src="https://code.jquery.com/jquery-3.2.1.min.js"></script>
<link rel="stylesheet" href="//cdn.datatables.net/1.10.21/css/jquery.dataTables.min.css">
<script src="//cdn.datatables.net/1.10.21/js/jquery.dataTables.min.js"></script>

<div class="MuiContainer-root jss110 MuiContainer-maxWidthLg">
  <div class="MuiGrid-root MuiGrid-container MuiGrid-spacing-xs-4">
    <div class="MuiGrid-root MuiGrid-item MuiGrid-grid-xs-12 MuiGrid-grid-md-8">
      <br><br>
      <input type="button" class="back" value="Πίσω" />
      <br><br>
      <input type="button" id="user_button" class="display-table-button" value="Οι αναλύσεις μου" />
      <input type="button" id="users_button" class="display-table-button" value="Αναλύσεις ανά κατάσταση" />
      <input type="button" id="entries_button" class="display-table-button"
        value="Αναλύσεις ανά κατάσταση & Υπουργείο" />
      <br><br>
      <table id="user_data" class="display">
        <thead>
          <tr>
            <th>Τίτλος</th>
            <th>Ονοματεπώνυμο συντάκτη</th>
            <th>Ρόλος συντάκτη</th>
            <th>Υπουργείο συντάκτη</th>
            <th>Τύπος ανάλυσης</th>
            <th>Κατάσταση αίτησης</th>
          </tr>
        </thead>
        <tbody>

          <% for(var i=0; i<user.ekthesis.length; i++) {%>
          <tr onclick="window.location.href='/form_a/<%=  user.ekthesis[i].id %>'">
            <td><%= user.ekthesis[i].title %></td>
            <td><%= user.fname%> <%= user.lname%></td>
            <td><%= user.rolos%></td>
            <td><%= user.ypoyrgeio %></td>
            <td><%= user.ekthesis[i].typos_analysis %></td>
            <td><%= user.ekthesis[i].status_ekthesis %></td>
          </tr>
          <% } %>

        </tbody>
      </table>
      <br><br>

      <table id="entries_data" class="display">
        <thead>
          <tr>
            <th>Τίτλος</th>
            <th>Ονοματεπώνυμο συντάκτη</th>
            <th>Ρόλος συντάκτη</th>
            <th>Υπουργείο συντάκτη</th>
            <th>Τύπος ανάλυσης</th>
            <th>Κατάσταση αίτησης</th>
          </tr>
        </thead>
        <tbody>
          <% if (entries != null) {%>
          <% for(var i=0; i<entries.length; i++) {%>
          <% if ( entries[i].user.ypoyrgeio == user.ypoyrgeio) {%>
          <tr onclick="window.location.href='/form_a/<%= entries[i].id %>'">
            <td><%= entries[i].title %></td>
            <td><%= entries[i].user.fname%> <%= entries[i].user.lname%></td>
            <td><%= entries[i].user.rolos%></td>
            <td><%= entries[i].user.ypoyrgeio %></td>
            <td><%= entries[i].typos_analysis %></td>
            <td><%= entries[i].status_ekthesis %></td>
          </tr>
          <% } %>
          <% } %>
          <% } %>
        </tbody>
      </table>
      <br><br>

      <table id="users_entries_data" class="display">
        <thead>
          <tr>
            <th>Τίτλος</th>
            <th>Ονοματεπώνυμο συντάκτη</th>
            <th>Ρόλος συντάκτη</th>
            <th>Υπουργείο συντάκτη</th>
            <th>Τύπος ανάλυσης</th>
            <th>Κατάσταση αίτησης</th>
          </tr>
        </thead>
        <tbody>
          <% if(users){%>
          <% for(var i=0; i<users.length; i++) {%>
          <% for(var j=0; j<users[i].ekthesis.length; j++) {%>
          <% if ( users[i].ypoyrgeio == user.ypoyrgeio) {%>
          <tr onclick="setReferer('<%= users[i].ekthesis[j].id %>')">
            <td><%= users[i].ekthesis[j].title %></td>
            <td><%= users[i].fname %> <%= users[i].lname %></td>
            <td><%= users[i].rolos %></td>
            <td><%= users[i].ypoyrgeio %></td>
            <td><%= users[i].ekthesis[j].typos_analysis %></td>
            <td><%= users[i].ekthesis[j].status_ekthesis %></td>
          </tr>
          <% } %>
          <% } %>
          <% } %>
          <% } %>
        </tbody>
      </table>
      <br><br>

      <%- include('../user_views/menus.ejs') %>
    </div>

  </div>

</div>

<%- include('../partials/footer.ejs') %>
</div>

<style>
  a {
    color: blue;
  }

  .display {
    table-layout: fixed;
    overflow-wrap: break-word;
  }

  .exit,
  .back,
  .display-table-button {
    font-size: 16px;
  }
</style>

<script>
  $(document).ready(function () {
    $('#users_entries_data').DataTable();
    $('#entries_data').DataTable();
  });

  function setReferer(id) {
    sessionStorage.setItem("referer", id);
    console.log(sessionStorage.getItem("referer"));
    window.location.href = '/form_a/' + id;
  }

  var user_role = '<%= user.rolos %>';
  var user_dikaiwmata_diaxeirisis = "<%= user.dikaiwmata_diaxeirisis %>"
  if (user_dikaiwmata_diaxeirisis) { //depending on administrational show menu
    $("#admin_menu").show();
    $("#user_menu").hide();
    //depending on user role hide menu items
    if (user_role == 'Βουλευτής') {
      document.getElementById("admin_ekthesi").children[1].style.display = "none";
      document.getElementById("admin_ekthesi").children[2].style.display = "none";
      document.getElementById("admin_ekthesi").children[3].style.display = "none";
      document.getElementById("admin_ekthesi").children[4].style.display = "none";
      document.getElementById("admin_ekthesi").children[6].style.display = "none";
      document.getElementById("admin_ekthesi").children[7].style.display = "none";
    } else if (user_role == 'Συντάκτης επισπεύδοντος Υπουργείου' || user_role == 'Νομοπαρασκευαστική Επιτροπή (ΓΓΝΚΘ)') {
      document.getElementById("admin_ekthesi").children[8].style.display = "none";
      document.getElementById("admin_ekthesi").children[5].style.display = "none";
    } else {
      document.getElementById("admin_ekthesi").children[0].style.display = "none";
      document.getElementById("admin_ekthesi").children[1].style.display = "none";
      document.getElementById("admin_ekthesi").children[2].style.display = "none";
      document.getElementById("admin_ekthesi").children[3].style.display = "none";
      document.getElementById("admin_ekthesi").children[4].style.display = "none";
      document.getElementById("admin_ekthesi").children[5].style.display = "none";
      document.getElementById("admin_ekthesi").children[6].style.display = "none";
      document.getElementById("admin_ekthesi").children[7].style.display = "none";
      document.getElementById("admin_ekthesi").children[8].style.display = "none";
    }
  }
  else {
    $("#user_menu").show();
    $("#admin_menu").hide();
    if (user_role == 'Βουλευτής') {
      document.getElementById("users_ekthesi").children[1].style.display = "none";
      document.getElementById("users_ekthesi").children[2].style.display = "none";
      document.getElementById("users_ekthesi").children[3].style.display = "none";
      document.getElementById("users_ekthesi").children[4].style.display = "none";
      document.getElementById("users_ekthesi").children[6].style.display = "none";
      document.getElementById("users_ekthesi").children[7].style.display = "none";
    } else if (user_role == 'Συντάκτης επισπεύδοντος Υπουργείου' || user_role == 'Νομοπαρασκευαστική Επιτροπή (ΓΓΝΚΘ)') {
      document.getElementById("users_ekthesi").children[5].style.display = "none";
      document.getElementById("users_ekthesi").children[8].style.display = "none";
    } else {
      document.getElementById("users_ekthesi").children[0].style.display = "none";
      document.getElementById("users_ekthesi").children[1].style.display = "none";
      document.getElementById("users_ekthesi").children[2].style.display = "none";
      document.getElementById("users_ekthesi").children[3].style.display = "none";
      document.getElementById("users_ekthesi").children[4].style.display = "none";
      document.getElementById("users_ekthesi").children[5].style.display = "none";
      document.getElementById("users_ekthesi").children[6].style.display = "none";
      document.getElementById("users_ekthesi").children[7].style.display = "none";
      document.getElementById("users_ekthesi").children[8].style.display = "none";
    }
  }
  //set width of column x
  /*$('#entries_data').dataTable({
    "columnDefs": [
      { "width": "20%", "targets": [5,6] }
    ]
  });*/
  //TODO: des pws ginetai hide to search
  $("#user_data").hide() // table is initially hidden as I add table rows to it using jQuery
  $("#user_data").dataTable(); // turn it into a datable
  $("#user_data_wrapper").hide(); //datables creates a div with my-table_wrapper
  

  if ("<%= user.ekthesis.length %>" == 0) {
    $("#user_data").hide();
  }

  $("#user_button").on("click", function (ev) {
  $("#user_data").show() // table is initially hidden as I add table rows to it using jQuery
  $("#user_data_wrapper").show(); //datables creates a div with my-table_wrapper
  });



  $(".back").on("click", function (ev) {
    if (user_dikaiwmata_diaxeirisis) {
      window.location.href = "/user_views/admin_dashboard";
    } else {
      window.location.href = "/user_views/user_dashboard";
    }
  });

</script>
</body>

</html>