<%- include('../partials/head.ejs') %>

    <div class="">
        <!--<input type="button" name="back" class="back" value="Πίσω"/> <br/>--> <a href="#" class="govgr-back-link"
            name="back" id="back"> <svg class="govgr-caret--left" viewBox="0 0 24 24" aria-hidden="true">
                <path d="M18,22V2L6,12L18,22z" />
            </svg>
            Επιστροφή στην αναζήτηση</a> <br />
        <div class="govgr-layout-wrapper govgr-layout-wrapper__full-height">
            <div class="govgr-width-container">
                <div class="govgr-main-wrapper">
                    <div class="govgr-grid-column-two-thirds">
                        <form>
                            <div id="errors" style="display: none;">
                                <!--Display validation errors here-->
                                <!-- <div class="alert alert-danger"> 
                    <ul id="alerts"></ul>                     
                </div>                 
            </div>   -->
                                <div class="bg-red-100 border border-red-400 text-red-700 px-4 py-3 rounded relative"
                                    role="alert">
                                    <a href="#" class="close" data-dismiss="alert" aria-label="close"></a> <strong>
                                        <ul id="alerts"></ul>
                                    </strong>
                                </div>
                            </div>
                            <h1 class="govgr-heading-xl">Επεξεργασία Στοιχείων Χρήστη</h1>
                            <div class="govgr-field">
                                <label class="govgr-label" for="fname"> <span>Όνομα χρήστη:</span>
                                    <input class="govgr-input govgr-!-width-one-half" type="text" id="fname"
                                        name="fname" placeholder="Όνομα χρήστη" value="<%= user.fname %>" required
                                        minlength="5" />
                                </label>
                            </div>
                            <hr />
                            <div class="govgr-field">
                                <label class="govgr-label" for="lname"> <span>Επώνυμο χρήστη:</span>
                                    <input class="govgr-input govgr-!-width-one-half" type="text" id="lname"
                                        name="lname" placeholder="Επώνυμο χρήστη" value="<%= user.lname %>" required
                                        minlength="5" />
                                </label>
                            </div>
                            <hr />
                            <div class="govgr-field">
                                <label class="govgr-label" for="username"> <span>Username:</span>
                                    <input class="govgr-input govgr-!-width-one-half" type="text" id="username"
                                        name="username" placeholder="Username" value="<%= user.username %>" required
                                        minlength="5" />
                                </label>
                            </div>
                            <hr />
                            <div class="govgr-field">
                                <label class="govgr-label" for="password"> <span>Κωδικός Πρόσβασης:</span>
                                    <input class="govgr-input govgr-!-width-one-half" type="password" id="password"
                                        name="password" minlength="8" />
                                </label>
                            </div>
                            <hr />
                            <div class="govgr-field">
                                <label class="govgr-label" for="password"> <span>Νέος Κωδικός Πρόσβασης:</span>
                                    <input class="govgr-input govgr-!-width-one-half" type="password" size="20"
                                        id="new_password" name="new_password" minlength="8"
                                        pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*_=+-]).{8,}$"
                                        oninvalid="this.setCustomValidity('Ο κωδικός πρέπει να περιέχει τουλάχιστον ένα πεζό και ένα κεφαλαίο γράμμα, έναν αριθμό και ένα σύμβολο(!@#$%^&*_=+-).')"
                                        oninput="this.setCustomValidity('')" />
                                </label>
                            </div>
                            <hr />
                            <div class="govgr-field">
                                <label class="govgr-label" for="password"> <span>Επανάληψη νέου κωδικού πρόσβασης
                                        χρήστη:</span>
                                    <input class="govgr-input govgr-!-width-one-half" type="password" size="20"
                                        id="password_repeat" name="password_repeat" minlength="8"
                                        pattern="^(?=.*[a-z])(?=.*[A-Z])(?=.*[0-9])(?=.*[!@#$%^&*_=+-]).{8,}$"
                                        oninvalid="this.setCustomValidity('Ο κωδικός πρέπει να περιέχει τουλάχιστον ένα πεζό και ένα κεφαλαίο γράμμα, έναν αριθμό και ένα σύμβολο(!@#$%^&*_=+-).')"
                                        oninput="this.setCustomValidity('')" />
                                </label>
                                <div id="msg"></div>
                            </div>
                            <hr />
                            <div class="govgr-field">
                                <label class="govgr-label" for="ypoyrgeio">
                                    Υπουργείο:
                                    <select class="govgr-select govgr-!-width-two-thirds" id="ypoyrgeio"
                                        name="ypoyrgeio" required>
                                        <option value="" selected disabled>Eπιλογή</option>
                                    </select>
                                </label>
                            </div>
                            <hr />
                            <div class="govgr-field">
                                <label class="govgr-label" for="role">
                                    Ρόλος:
                                    <select class="govgr-select govgr-!-width-two-thirds" id="role" name="role">
                                        <option selected disabled>Eπιλογή</option>
                                        <option value="Συντάκτης επισπεύδοντος Υπουργείου">Συντάκτης επισπεύδοντος
                                            Υπουργείου
                                        </option>
                                        <option
                                            value="Αρμόδιος επισπεύδοντος Υπουργείου και άλλων συναρμόδιων Υπουργείων">
                                            Αρμόδιος επισπεύδοντος Υπουργείου και άλλων συναρμόδιων Υπουργείων
                                        </option>
                                        <option value="Βουλευτής">Βουλευτής</option>
                                        <option value="Νομοπαρασκευαστική Επιτροπή (ΓΓΝΚΘ)">Νομοπαρασκευαστική Επιτροπή
                                            (ΓΓΝΚΘ)
                                        </option>
                                        <option value="Γενικό Λογιστήριο του Κράτους">Γενικό Λογιστήριο του Κράτους
                                        </option>
                                        <option
                                            value="Επιτροπή Αξιολόγησης Ποιότητας της Νομοπαρασκευαστικής Διαδικασίας (ΓΓΝΚΘ)">
                                            Επιτροπή Αξιολόγησης Ποιότητας της Νομοπαρασκευαστικής Διαδικασίας (ΓΓΝΚΘ)
                                        </option>
                                        <option value="Γραφείο Καλής Νομοθέτησης (ΓΓΝΚΘ)">Γραφείο Καλής Νομοθέτησης
                                            (ΓΓΝΚΘ)</option>
                                        <option value="Διεύθυνση Νομοπαρασκευαστικής Διαδικασίας (ΓΓΝΚΘ)">Διεύθυνση
                                            Νομοπαρασκευαστική Διαδικασίας (ΓΓΝΚΘ)
                                        </option>
                                        <option value="Γενικός Γραμματέας Νομικών και Κοινοβουλευτικών Θεμάτων">Γενικός
                                            Γραμματέας Νομικών και Κοινοβουλευτικών Θεμάτων
                                        </option>
                                        <option value="Βουλή">Βουλή</option>
                                    </select>
                                </label>
                            </div> <br />
                            <div class="govgr-field">
                                <fieldset class="govgr-fieldset">
                                    <legend for="isAdmin" role="heading" aria-level="1"
                                        class="govgr-fieldset__legend govgr-heading-l">
                                        Δικαιώματα Διαχείρισης
                                    </legend>
                                    <p class="govgr-hint">
                                        Ο χρήστης έχει δικαιώματα διαχείρισης: </p>
                                    <div class="govgr-checkboxes" id="isAdmin_checkbox">
                                        <div class="govgr-checkboxes__item">
                                            <label class="govgr-label govgr-checkboxes__label">
                                                <input class="govgr-checkboxes__input" type="checkbox" id="isAdmin"
                                                    name="isAdmin" />
                                                <input type="hidden" name="isAdmin" id="isAdmin_hidden" />
                                            </label>
                                        </div>
                                    </div>
                                </fieldset>
                            </div>
                            <hr /> <br />
                            <div class="govgr-button-group">
                                <input type="submit" id="edit_submit" name="edit_submit"
                                    class="govgr-btn govgr-btn-primary" value="Επεξεργασία" />
                                <button id="delete_user" class="govgr-btn govgr-btn-warning">Διαγραφή Χρήστη</button>
                            </div>
                        </form>
                    </div>
                </div>
            </div>
        </div>
    </div>
    <%- include('../partials/footer.ejs') %>
        </div>

        <style>
            * {
                box-sizing: border-box;
            }


            /* Full-width input fields */
            /* input[type=text],
            input[type=password] {
                width: 100%;
                padding: 15px;
                margin: 5px 0 22px 0;
                display: inline-block;
                border: 2px solid #ccc;
                border-radius: 4px;
                background: #f1f1f1;
            }*/

            /*input[type=text]:focus,
            input[type=password]:focus {
                background-color: #ddd;
                outline: none;
            }*/

            /* Overwrite default styles of hr 
            hr {
                border: 1px solid #f1f1f1;
                margin-bottom: 25px;
            }*/

            .checkbox-group {
                display: flex;
                align-items: center;
            }

            .action-button,
            .back {
                font-size: 16px;
            }
        </style>
        <script type="text/javascript" src="/js/nav_scripts.js"></script>
        <script type="text/javascript" src="/js/enums.js"></script>
        <script>
            const userRole = "<%= user.role %>";
            setUserRestrictions(userRole);
            const isAdmin = '<%= user.isAdmin %>';

            let username = $("#username").val();
            $("#delete_user").on("click", function (ev) {
                ev.preventDefault();
                let answer = window.confirm("Διαγραφή χρήστη;");
                if (answer) {
                    $.ajax({
                        url: '/user_views/edit_user/' + username,
                        data: $(this).serialize(),
                        error: function (error) {
                            console.log(error)
                        },
                        success: function (data) {
                            window.location = data.redirect;
                        },
                        type: 'DELETE'
                    });
                }

            });

            let validationErrors;
            $("form").on("submit", function (ev) {
                ev.preventDefault();

                if ($("#password_repeat").val() != $("#new_password").val()) {
                    ev.preventDefault();
                    validationErrors = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><li>Οι νέοι κωδικοί δεν ταιριάζουν.</li>';
                    $('#alerts').empty();
                    $('#alerts').html(validationErrors);
                    $('#errors').show();
                    window.scrollTo(0, 0);
                } else if (!username) {
                    validationErrors = '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a><li>Έχετε εισαγάγει λανθασμένα στοιχεία.</li>';
                    $('#alerts').empty();
                    $('#alerts').html(validationErrors);
                    $('#errors').show();
                    window.scrollTo(0, 0);
                } else {
                    ev.preventDefault();
                    $("#isAdmin").prop('checked') ? $("#isAdmin_hidden").prop('disabled', true) : $("#isAdmin").prop('disabled', true);
                    $.ajax({
                        url: '/user_views/edit_user/' + username,
                        data: $(this).serialize(),
                        error: function (error) {
                            console.log(error)
                            let errors = JSON.parse(error.responseText);
                            $('#errors').show();
                            let alerts = '';
                            for (i in errors) {
                                console.log(errors[i].msg)
                                alerts += '<a href="#" class="close" data-dismiss="alert" aria-label="close">&times;</a>' + "<li>" + errors[i].msg + "</li>";
                            }
                            $('#alerts').empty();
                            $('#alerts').html(alerts);
                            window.scrollTo(0, 0);
                        },
                        success: function (data) {
                            window.location = data.redirect
                        },
                        type: 'PUT'
                    });
                }

            });

            $("#back").on("click", function (ev) {
                window.location.href = "/user_views/search_user";
            });

            ///////////////////////////////Handle ministries/////////////////////////////////////

            let ministries = JSON.parse(' <%- JSON.stringify(ministries) %> ');
            for (i in ministries) {
                $("#ypoyrgeio").append(`<option value="${ministries[i].ministry}">${ministries[i].ministry}</option>`);
            }
            let ministryValue = "<%= user.agency %>";
            let roleValue = "<%= user.role %>";
            $("#ypoyrgeio").val(ministryValue ? ministryValue : $("#ypoyrgeio option:first").val());//if user is assigned a ministry, set dropdown accordingly, else set to first option
            $("#role").val(roleValue ? roleValue : $("#ypoyrgeio option:first").val());//if user is assigned a role, set dropdown accordingly, else set to first option



            /////////////////////////////////////////////////////////////////////////////////////        

            if ("<%= user.isAdmin %>") {
                $("#isAdmin").prop('checked', true);
            }

            $("#password_repeat, #new_password").keyup(function () {
                passwordsMatch();
            });

            function passwordsMatch() {
                if (($("#password_repeat").val() == $("#new_password").val() && $("#new_password").val() != '')) {
                    $("#msg").html("Οι κωδικοί ταιριάζουν.").css("color", "green");
                } else if (!$("#password_repeat").val() && !$("#new_password").val()) {
                    $("#msg").empty();
                } else {
                    $("#msg").html("Οι κωδικοί δεν ταιριάζουν.").css("color", "red");
                }
            }

        </script>
        <script type="text/javascript" src="/js/common_user_scripts.js"></script>
        </body>

        </html>